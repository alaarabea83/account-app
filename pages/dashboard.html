<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="../icons/logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@600;700&family=Tajawal:wght@400;500&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <title>سهل لإدارة الحسابات</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .breadcrumb {
      background: #0f172a;
      padding: 12px 20px;
      max-width: 100%;
      text-align: center;
    }

    .breadcrumb a {
      color: yellow;
      text-decoration: none;
    }

    .breadcrumb .active {
      color: #bdc3c7;
    }

    @media (max-width: 768px) {
      .breadcrumb {
        /* مسافة من كل الجهات */
        padding: 14px 16px;
        /* راحة للمس */
      }
    }

    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: white;
      --accent: #38bdf8;
    }

    .light {
      --bg: #f1f5f9;
      --card: white;
      --text: #0f172a;
    }

    body {
      margin: 0;
      font-family: Cairo;
      background: var(--bg);
      color: var(--text);
      transition: .3s;
    }

    .header {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      background: var(--card);
      font-weight: bold;
    }

    .btn {
      background: var(--accent);
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 12px;
    }

    .stat {
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }

    .stat h2 {
      color: var(--accent);
      margin: 5px;
    }

    .chart-box {
      background: var(--card);
      margin: 12px;
      padding: 12px;
      border-radius: 14px;
    }

    /* مودال الخسارة العصري */
    .loss-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .55);
      backdrop-filter: blur(6px);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: .3s;
      z-index: 9999;
    }

    .loss-modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .loss-box {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      padding: 30px;
      border-radius: 18px;
      text-align: center;
      width: 320px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .6);
      animation: pop .4s ease;
      border: 1px solid #334155;
    }

    @keyframes pop {
      from {
        transform: scale(.7);
        opacity: 0
      }

      to {
        transform: scale(1);
        opacity: 1
      }
    }

    .loss-icon {
      font-size: 50px;
      margin-bottom: 10px;
    }

    .loss-box h2 {
      color: #ef4444;
      margin-bottom: 10px;
    }

    .loss-box p {
      color: #cbd5f5;
      margin-bottom: 20px;
    }

    .loss-box button {
      background: #ef4444;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 15px;
    }

    .loss-box button:hover {
      background: #dc2626;
    }
  </style>
</head>

<body>

  <div class="header">
    سهل لإدارة الحسابات
  </div>

  <nav class="breadcrumb">
    <a href="../index.html">الرئيسية</a> /
    <span class="active">تقرير الحركه</span>
  </nav>

  <!-- العدادات -->
  <div class="stats">

    <div class="stat">
      <h2 id="cust">0</h2>
      العملاء
    </div>

    <div class="stat">
      <h2 id="inv">0</h2>
      الفواتير
    </div>

    <div class="stat">
      <h2 id="salesT">0</h2>
      المبيعات
    </div>

    <div class="stat">
      <h2 id="profit">0</h2>
      الربح الكلي
    </div>

    <div class="stat">
      <h2 id="profitDay">0</h2>
      ربح اليوم
    </div>

    <div class="stat">
      <h2 id="profitMonth">0</h2>
      ربح الشهر
    </div>

  </div>

  <!-- الرسم البياني -->
  <div class="chart-box">
    <canvas id="chart"></canvas>
  </div>

  <!-- مودال الخسارة -->
  <div id="lossModal" class="loss-modal">
    <div class="loss-box">
      <div class="loss-icon">⚠️</div>
      <h2>تنبيه خسارة</h2>
      <p id="lossText">يوجد خسارة في الأرباح</p>

      <button onclick="closeLossModal()">حسناً</button>
    </div>
  </div>

  <script>

    /////////////////////////
    // تحميل البيانات
    /////////////////////////

    const customers = JSON.parse(localStorage.getItem("customers")) || [];
    const sales = JSON.parse(localStorage.getItem("sales")) || [];
    const purchases = JSON.parse(localStorage.getItem("purchases")) || [];
    const products = JSON.parse(localStorage.getItem("products")) || [];
    const expenses = JSON.parse(localStorage.getItem("expenses")) || [];

    /////////////////////////
    // العدادات
    /////////////////////////

    cust.innerText = customers.length;
    inv.innerText = sales.length;

    /////////////////////////
    // إجمالي المبيعات
    /////////////////////////

    let totalSales = 0;

    sales.forEach(inv => {
      if (inv.items) {
        inv.items.forEach(i => {
          totalSales += i.price * i.qty;
        });
      } else {
        totalSales += Number(inv.total || 0);
      }
    });

    salesT.innerText = totalSales.toFixed(2);

    /////////////////////////
    // حساب الربح الحقيقي
    /////////////////////////

    function calcProfit(filterFn) {

      let profit = 0;

      sales.filter(filterFn).forEach(inv => {
        let t = 0, c = 0;

        inv.items?.forEach(item => {
          const pr = products.find(p => p.name == item.name);
          const buy = pr ? Number(pr.buyPrice || 0) : 0;

          t += item.price * item.qty;
          c += buy * item.qty;
        });

        profit += (t - c);
      });

      const exp = expenses
        .filter(filterFn)
        .reduce((s, e) => s + Number(e.amount || 0), 0);

      return profit - exp;
    }

    /////////////////////////
    // فلترة زمنية
    /////////////////////////

    const today = new Date();

    const isToday = d => {
      const x = new Date(d);
      return x.toDateString() == today.toDateString();
    };

    const isMonth = d => {
      const x = new Date(d);
      return x.getMonth() == today.getMonth()
        && x.getFullYear() == today.getFullYear();
    };

    /////////////////////////
    // عرض الأرباح
    /////////////////////////

    profit.innerText = calcProfit(() => true).toFixed(2);
    profitDay.innerText = calcProfit(s => isToday(s.date)).toFixed(2);
    profitMonth.innerText = calcProfit(s => isMonth(s.date)).toFixed(2);

    /////////////////////////
    // تنبيه خسارة
    /////////////////////////

    if (calcProfit(() => true) < 0) {
      showLossModal(calcProfit(() => true));
    }


    /////////////////////////
    // رسم بياني 6 شهور
    /////////////////////////

    const monthNames = [
      "يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو",
      "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"
    ];

    let labels = [];
    let data = [];

    for (let i = 5; i >= 0; i--) {
      const d = new Date();
      d.setMonth(d.getMonth() - i);

      const m = d.getMonth();
      const y = d.getFullYear();

      const p = calcProfit(s => {
        const x = new Date(s.date);
        return x.getMonth() == m && x.getFullYear() == y;
      });

      labels.push(monthNames[m]);
      data.push(p.toFixed(2));
    }

    new Chart(chart, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "الأرباح الشهرية",
          data: data
        }]
      }
    });

    /////////////////////////
    // الوضع الليلي
    /////////////////////////

    function toggleMode() {
      document.body.classList.toggle("light");
      localStorage.setItem("mode",
        document.body.classList.contains("light") ? "light" : "dark");
    }

    if (localStorage.getItem("mode") == "light") {
      document.body.classList.add("light");
    }

    /////////////////////////
    // Backup
    /////////////////////////

    function backup() {
      let data = JSON.stringify(localStorage);
      let blob = new Blob([data]);
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "backup.json";
      a.click();
    }

    /////////////////////////
    // Restore
    /////////////////////////

    function restore() {
      let i = document.createElement("input");
      i.type = "file";

      i.onchange = e => {
        let f = e.target.files[0];
        let r = new FileReader();

        r.onload = () => {
          let d = JSON.parse(r.result);
          for (let k in d) {
            localStorage.setItem(k, d[k]);
          }
          location.reload();
        };

        r.readAsText(f);
      };

      i.click();
    }

    function showLossModal(value) {
      document.getElementById("lossText").innerText =
        `يوجد خسارة بقيمة ${value.toFixed(2)} جنيه`;

      document.getElementById("lossModal").classList.add("show");
    }

    function closeLossModal() {
      document.getElementById("lossModal").classList.remove("show");
    }


  </script>

</body>

</html>