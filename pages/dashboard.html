<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <title>Dashboard V2</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .breadcrumb {
      background: linear-gradient(135deg, #34495e, #2c3e50);
      padding: 12px 20px;
      border-radius: 12px;
      margin: 16px auto;
      max-width: 1000px;
    }

    .breadcrumb a {
      color: #5dade2;
      text-decoration: none;
    }

    .breadcrumb .active {
      color: #bdc3c7;
    }

    @media (max-width: 768px) {
      .breadcrumb {
        margin: 12px 12px;
        /* Ù…Ø³Ø§ÙØ© Ù…Ù† ÙƒÙ„ Ø§Ù„Ø¬Ù‡Ø§Øª */
        padding: 14px 16px;
        /* Ø±Ø§Ø­Ø© Ù„Ù„Ù…Ø³ */
      }
    }

    :root {
      --bg: #0f172a;
      --card: #1e293b;
      --text: white;
      --accent: #38bdf8;
    }

    .light {
      --bg: #f1f5f9;
      --card: white;
      --text: #0f172a;
    }

    body {
      margin: 0;
      font-family: Cairo;
      background: var(--bg);
      color: var(--text);
      transition: .3s;
    }

    .header {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      background: var(--card);
      font-weight: bold;
    }

    .btn {
      background: var(--accent);
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding: 12px;
    }

    .stat {
      background: var(--card);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
    }

    .stat h2 {
      color: var(--accent);
      margin: 5px;
    }

    .chart-box {
      background: var(--card);
      margin: 12px;
      padding: 12px;
      border-radius: 14px;
    }

    /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ø¹ØµØ±ÙŠ */
    .loss-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .55);
      backdrop-filter: blur(6px);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: .3s;
      z-index: 9999;
    }

    .loss-modal.show {
      opacity: 1;
      pointer-events: auto;
    }

    .loss-box {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      padding: 30px;
      border-radius: 18px;
      text-align: center;
      width: 320px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .6);
      animation: pop .4s ease;
      border: 1px solid #334155;
    }

    @keyframes pop {
      from {
        transform: scale(.7);
        opacity: 0
      }

      to {
        transform: scale(1);
        opacity: 1
      }
    }

    .loss-icon {
      font-size: 50px;
      margin-bottom: 10px;
    }

    .loss-box h2 {
      color: #ef4444;
      margin-bottom: 10px;
    }

    .loss-box p {
      color: #cbd5f5;
      margin-bottom: 20px;
    }

    .loss-box button {
      background: #ef4444;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 15px;
    }

    .loss-box button:hover {
      background: #dc2626;
    }
  </style>
</head>

<body>

  <div class="header">
    Ø³Ù‡Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    <div>
      <button class="btn" onclick="toggleMode()">ğŸŒ™</button>
      <button class="btn" onclick="backup()">ğŸ’¾</button>
      <button class="btn" onclick="restore()">ğŸ“‚</button>
    </div>
  </div>

  <nav class="breadcrumb">
    <a href="../index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a> /
    <span class="active">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
  </nav>

  <!-- Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div class="stats">

    <div class="stat">
      <h2 id="cust">0</h2>
      Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    </div>

    <div class="stat">
      <h2 id="inv">0</h2>
      Ø§Ù„ÙÙˆØ§ØªÙŠØ±
    </div>

    <div class="stat">
      <h2 id="salesT">0</h2>
      Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    </div>

    <div class="stat">
      <h2 id="profit">0</h2>
      Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙƒÙ„ÙŠ
    </div>

    <div class="stat">
      <h2 id="profitDay">0</h2>
      Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…
    </div>

    <div class="stat">
      <h2 id="profitMonth">0</h2>
      Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±
    </div>

  </div>

  <!-- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ -->
  <div class="chart-box">
    <canvas id="chart"></canvas>
  </div>

  <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø®Ø³Ø§Ø±Ø© -->
  <div id="lossModal" class="loss-modal">
    <div class="loss-box">
      <div class="loss-icon">âš ï¸</div>
      <h2>ØªÙ†Ø¨ÙŠÙ‡ Ø®Ø³Ø§Ø±Ø©</h2>
      <p id="lossText">ÙŠÙˆØ¬Ø¯ Ø®Ø³Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­</p>

      <button onclick="closeLossModal()">Ø­Ø³Ù†Ø§Ù‹</button>
    </div>
  </div>

  <script>

    /////////////////////////
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    /////////////////////////

    const customers = JSON.parse(localStorage.getItem("customers")) || [];
    const sales = JSON.parse(localStorage.getItem("sales")) || [];
    const purchases = JSON.parse(localStorage.getItem("purchases")) || [];
    const products = JSON.parse(localStorage.getItem("products")) || [];
    const expenses = JSON.parse(localStorage.getItem("expenses")) || [];

    /////////////////////////
    // Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
    /////////////////////////

    cust.innerText = customers.length;
    inv.innerText = sales.length;

    /////////////////////////
    // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
    /////////////////////////

    let totalSales = 0;

    sales.forEach(inv => {
      if (inv.items) {
        inv.items.forEach(i => {
          totalSales += i.price * i.qty;
        });
      } else {
        totalSales += Number(inv.total || 0);
      }
    });

    salesT.innerText = totalSales.toFixed(2);

    /////////////////////////
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    /////////////////////////

    function calcProfit(filterFn) {

      let profit = 0;

      sales.filter(filterFn).forEach(inv => {
        let t = 0, c = 0;

        inv.items?.forEach(item => {
          const pr = products.find(p => p.name == item.name);
          const buy = pr ? Number(pr.buyPrice || 0) : 0;

          t += item.price * item.qty;
          c += buy * item.qty;
        });

        profit += (t - c);
      });

      const exp = expenses
        .filter(filterFn)
        .reduce((s, e) => s + Number(e.amount || 0), 0);

      return profit - exp;
    }

    /////////////////////////
    // ÙÙ„ØªØ±Ø© Ø²Ù…Ù†ÙŠØ©
    /////////////////////////

    const today = new Date();

    const isToday = d => {
      const x = new Date(d);
      return x.toDateString() == today.toDateString();
    };

    const isMonth = d => {
      const x = new Date(d);
      return x.getMonth() == today.getMonth()
        && x.getFullYear() == today.getFullYear();
    };

    /////////////////////////
    // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
    /////////////////////////

    profit.innerText = calcProfit(() => true).toFixed(2);
    profitDay.innerText = calcProfit(s => isToday(s.date)).toFixed(2);
    profitMonth.innerText = calcProfit(s => isMonth(s.date)).toFixed(2);

    /////////////////////////
    // ØªÙ†Ø¨ÙŠÙ‡ Ø®Ø³Ø§Ø±Ø©
    /////////////////////////

    if (calcProfit(() => true) < 0) {
      showLossModal(calcProfit(() => true));
    }


    /////////////////////////
    // Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ 6 Ø´Ù‡ÙˆØ±
    /////////////////////////

    const monthNames = [
      "ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ",
      "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"
    ];

    let labels = [];
    let data = [];

    for (let i = 5; i >= 0; i--) {
      const d = new Date();
      d.setMonth(d.getMonth() - i);

      const m = d.getMonth();
      const y = d.getFullYear();

      const p = calcProfit(s => {
        const x = new Date(s.date);
        return x.getMonth() == m && x.getFullYear() == y;
      });

      labels.push(monthNames[m]);
      data.push(p.toFixed(2));
    }

    new Chart(chart, {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø±ÙŠØ©",
          data: data
        }]
      }
    });

    /////////////////////////
    // Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
    /////////////////////////

    function toggleMode() {
      document.body.classList.toggle("light");
      localStorage.setItem("mode",
        document.body.classList.contains("light") ? "light" : "dark");
    }

    if (localStorage.getItem("mode") == "light") {
      document.body.classList.add("light");
    }

    /////////////////////////
    // Backup
    /////////////////////////

    function backup() {
      let data = JSON.stringify(localStorage);
      let blob = new Blob([data]);
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "backup.json";
      a.click();
    }

    /////////////////////////
    // Restore
    /////////////////////////

    function restore() {
      let i = document.createElement("input");
      i.type = "file";

      i.onchange = e => {
        let f = e.target.files[0];
        let r = new FileReader();

        r.onload = () => {
          let d = JSON.parse(r.result);
          for (let k in d) {
            localStorage.setItem(k, d[k]);
          }
          location.reload();
        };

        r.readAsText(f);
      };

      i.click();
    }

    function showLossModal(value) {
      document.getElementById("lossText").innerText =
        `ÙŠÙˆØ¬Ø¯ Ø®Ø³Ø§Ø±Ø© Ø¨Ù‚ÙŠÙ…Ø© ${value.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;

      document.getElementById("lossModal").classList.add("show");
    }

    function closeLossModal() {
      document.getElementById("lossModal").classList.remove("show");
    }


  </script>

</body>

</html>